<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the dark mode toggle switch and icons */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(16px);
        }
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-8">

    <!-- Main Container -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 max-w-4xl w-full relative">
        <!-- Dark Mode Toggle -->
        <div class="absolute top-4 right-4 flex items-center space-x-2">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Dark Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="darkModeToggle">
                <span class="slider"></span>
            </label>
        </div>

        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2 text-center">Incident Tracker</h1>
        <p class="text-gray-500 dark:text-gray-400 mb-8 text-center">Document all incidents for your legal case with your neighbour.</p>
        
        <!-- Incident Input Form -->
        <div class="space-y-6">
            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Log a New Incident</h2>
            
            <div>
                <label for="incidentType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Incident Type</label>
                <select id="incidentType" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                    <option value="harassment">Harassment</option>
                    <option value="trespassing">Trespassing</option>
                    <option value="tree-damage">Tree Damage</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div>
                <label for="incidentDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date of Incident</label>
                <input type="date" id="incidentDate" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
            </div>

            <div>
                <label for="incidentTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Time of Incident</label>
                <input type="time" id="incidentTime" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
            </div>

            <div>
                <label for="incidentDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                <textarea id="incidentDescription" rows="4" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="e.g., Neighbour yelled at me from their driveway."></textarea>
            </div>

            <div>
                <label for="witnesses" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Witnesses (if any)</label>
                <input type="text" id="witnesses" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="e.g., John Smith, Jane Doe">
            </div>

            <div class="flex flex-col sm:flex-row sm:space-x-4">
                <div class="flex-1 mb-4 sm:mb-0">
                    <label for="documentation" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Attach Photos/Videos</label>
                    <input type="file" id="documentation" multiple accept="image/*,video/*" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <div id="filePreview" class="flex flex-wrap items-center mt-2 space-x-2"></div>
                </div>

                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Record a Voice Memo</label>
                    <button id="recordButton" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 mt-1">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        Start Recording
                    </button>
                    <div id="audioPreview" class="mt-2 text-xs text-gray-500 dark:text-gray-400"></div>
                </div>
            </div>

            <button onclick="logIncident()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Log Incident
            </button>
        </div>

        <hr class="my-8 border-gray-300 dark:border-gray-600">

        <!-- Logged Incidents Display -->
        <div class="space-y-6">
            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Incident Log</h2>
            <div id="incidentLog" class="space-y-4">
                <p id="noIncidentsMessage" class="text-gray-500 dark:text-gray-400 text-center">No incidents logged yet.</p>
            </div>
            <div id="logButtons" class="mt-4 hidden space-y-2">
                <button onclick="clearLog()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Clear All Incidents
                </button>
                <button onclick="downloadLog()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Download Log
                </button>
            </div>
            <div id="downloadInstructions" class="mt-8 p-4 bg-gray-100 dark:bg-gray-700 rounded-md text-sm text-gray-700 dark:text-gray-200 hidden">
                <p class="font-bold mb-2">Instructions for your Log:</p>
                <p>You have successfully downloaded a **.json** file. This is a text-based file that contains all your logged incident data. To view it, you can open it with any text editor (like Notepad, TextEdit, or VS Code).</p>
                <p class="mt-2">For your attached photos and files, you will need to save them separately on your computer. Your log will reference their filenames, but it will not contain the actual file content to keep the log small and fast.</p>
            </div>
        </div>
        
        <!-- Version Number -->
        <p class="text-xs text-gray-400 dark:text-gray-500 text-center mt-8">v1.4</p>
    </div>

    <!-- Modal for displaying message -->
    <div id="messageModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-700 dark:border-gray-600">
            <div class="mt-3 text-center">
                <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modalMessage" class="text-sm text-gray-500 dark:text-gray-300"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="okBtn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Array to hold incident data
        let incidents = [];
        let mediaRecorder;
        let recordedChunks = [];
        let recordedAudioFile = null;
        let recordingStatus = false;
        
        // DOM elements
        const incidentTypeEl = document.getElementById('incidentType');
        const incidentDateEl = document.getElementById('incidentDate');
        const incidentTimeEl = document.getElementById('incidentTime');
        const incidentDescriptionEl = document.getElementById('incidentDescription');
        const witnessesEl = document.getElementById('witnesses');
        const documentationEl = document.getElementById('documentation');
        const filePreviewEl = document.getElementById('filePreview');
        const incidentLogEl = document.getElementById('incidentLog');
        const noIncidentsMessageEl = document.getElementById('noIncidentsMessage');
        const logButtonsEl = document.getElementById('logButtons');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const okBtn = document.getElementById('okBtn');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const downloadInstructionsEl = document.getElementById('downloadInstructions');
        const recordButton = document.getElementById('recordButton');
        const audioPreviewEl = document.getElementById('audioPreview');

        // Event listener for OK button on modal
        okBtn.onclick = () => {
            messageModal.classList.add('hidden');
        };

        // Dark mode functionality
        const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
            darkModeToggle.checked = true;
        }

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Event listener for file input to show previews
        documentationEl.addEventListener('change', () => {
            filePreviewEl.innerHTML = '';
            for (const file of documentationEl.files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'image-preview';
                        filePreviewEl.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                } else if (file.type.startsWith('video/')) {
                    const span = document.createElement('span');
                    span.textContent = `ðŸ“¹ ${file.name}`;
                    span.className = 'text-xs text-gray-500 dark:text-gray-400 p-1 rounded-md bg-gray-200 dark:bg-gray-600';
                    filePreviewEl.appendChild(span);
                } else {
                    const span = document.createElement('span');
                    span.textContent = `ðŸ“ ${file.name}`;
                    span.className = 'text-xs text-gray-500 dark:text-gray-400 p-1 rounded-md bg-gray-200 dark:bg-gray-600';
                    filePreviewEl.appendChild(span);
                }
            }
        });

        // Function to show the custom message modal
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        /**
         * Toggles the audio recording on and off.
         */
        async function toggleRecording() {
            if (recordingStatus) {
                // Stop recording
                mediaRecorder.stop();
                recordingStatus = false;
                recordButton.textContent = "Start Recording";
                recordButton.classList.replace('bg-red-600', 'bg-pink-600');
            } else {
                // Start recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    recordedChunks = [];
                    recordedAudioFile = null;

                    mediaRecorder.ondataavailable = (event) => {
                        recordedChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                        recordedAudioFile = new File([audioBlob], `voice_memo_${Date.now()}.webm`, { type: 'audio/webm' });
                        showAudioPreview(recordedAudioFile);
                    };

                    mediaRecorder.start();
                    recordingStatus = true;
                    recordButton.textContent = "Stop Recording";
                    recordButton.classList.replace('bg-pink-600', 'bg-red-600');
                    audioPreviewEl.innerHTML = `<span class="text-pink-600">Recording...</span>`;

                } catch (err) {
                    showModal("Permission Error", "Could not access the microphone. Please grant permission.");
                    console.error('Error accessing microphone:', err);
                }
            }
        }
        
        // Add click listener for record button
        recordButton.addEventListener('click', toggleRecording);

        /**
         * Displays a preview for the recorded audio file.
         * @param {File} audioFile The recorded audio file.
         */
        function showAudioPreview(audioFile) {
            const audioUrl = URL.createObjectURL(audioFile);
            audioPreviewEl.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-gray-500 dark:text-gray-400">ðŸŽ¤ ${audioFile.name}</span>
                    <audio controls src="${audioUrl}" class="h-6"></audio>
                </div>
            `;
        }


        /**
         * Logs a new incident from the form inputs.
         * It validates the required fields and then adds the incident to the log.
         */
        function logIncident() {
            const type = incidentTypeEl.value;
            const date = incidentDateEl.value;
            const time = incidentTimeEl.value;
            const description = incidentDescriptionEl.value.trim();
            const witnesses = witnessesEl.value.trim();
            
            const fileList = Array.from(documentationEl.files);
            if (recordedAudioFile) {
                fileList.push(recordedAudioFile);
            }
            
            if (!date || !description) {
                showModal("Validation Error", "Please enter a date and a description for the incident.");
                return;
            }

            const incident = {
                id: Date.now(),
                type: type,
                date: date,
                time: time,
                description: description,
                witnesses: witnesses,
                documentation: []
            };

            // Store only the filenames to keep the log small
            for (const file of fileList) {
                incident.documentation.push({
                    name: file.name,
                    note: "File attached. Please save the original file separately."
                });
            }

            incidents.push(incident);
            renderLog();
            clearForm();
        }

        /**
         * Renders the logged incidents to the UI.
         */
        function renderLog() {
            // Sort incidents by date in descending order
            incidents.sort((a, b) => new Date(b.date) - new Date(a.date));

            incidentLogEl.innerHTML = '';
            if (incidents.length === 0) {
                noIncidentsMessageEl.classList.remove('hidden');
                logButtonsEl.classList.add('hidden');
                downloadInstructionsEl.classList.add('hidden');
            } else {
                noIncidentsMessageEl.classList.add('hidden');
                logButtonsEl.classList.remove('hidden');
                downloadInstructionsEl.classList.remove('hidden');
                incidents.forEach(incident => {
                    const incidentEl = document.createElement('div');
                    incidentEl.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-4 shadow-inner';
                    incidentEl.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-gray-800 dark:text-gray-100 capitalize">${incident.type.replace('-', ' ')}</span>
                            <span class="text-sm text-gray-500 dark:text-gray-400">${incident.date} at ${incident.time || 'N/A'}</span>
                        </div>
                        <p class="text-gray-700 dark:text-gray-200 text-sm mb-2">${incident.description}</p>
                        ${incident.witnesses ? `<p class="text-gray-600 dark:text-gray-300 text-xs mt-2"><strong>Witnesses:</strong> ${incident.witnesses}</p>` : ''}
                        ${incident.documentation.length > 0 ? `
                            <div class="mt-4">
                                <p class="text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">Attached Files:</p>
                                <ul class="list-disc list-inside space-y-1">
                                    ${incident.documentation.map(doc => `
                                        <li class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                                            <span>${doc.name}</span>
                                            <span class="text-gray-400 text-xs ml-2">(${doc.note})</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <button onclick="deleteIncident(${incident.id})" class="mt-4 text-xs font-semibold text-red-600 hover:text-red-800">Delete</button>
                    `;
                    incidentLogEl.appendChild(incidentEl);
                });
            }
        }

        /**
         * Clears the incident log form inputs.
         */
        function clearForm() {
            incidentTypeEl.value = 'harassment';
            incidentDateEl.value = '';
            incidentTimeEl.value = '';
            incidentDescriptionEl.value = '';
            witnessesEl.value = '';
            documentationEl.value = '';
            filePreviewEl.innerHTML = '';
            audioPreviewEl.innerHTML = '';
            recordedAudioFile = null;
        }

        /**
         * Deletes an incident from the log by its ID.
         * @param {number} id The unique ID of the incident to delete.
         */
        function deleteIncident(id) {
            incidents = incidents.filter(incident => incident.id !== id);
            renderLog();
        }

        /**
         * Clears all incidents from the log.
         */
        function clearLog() {
            incidents = [];
            renderLog();
            showModal("Log Cleared", "All incidents have been successfully cleared.");
        }

        /**
         * Downloads the incident log as a JSON file.
         */
        function downloadLog() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(incidents, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "incident_log.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // Initial render
        renderLog();

    </script>
</body>
</html>
